presubmits:
  - name: nmath-test
    decorate: true
    always_run: true
    spec:
      containers:
      - image: golang:1.12.5
        command:
        - make
        args:
        - test
postsubmits:
  - name: nmath-docker-image
    decorate: true
    decoration_config:
      censor_secrets: true
    always_run: true
    spec:
      containers:
      - image: docker:latest
        command:
        - "/bin/sh"
        - "-c"
        - |
          docker build -t radoslawc/nmath-test:latest .
          docker login -u $(echo $DOCKER_USERNAME) -p $(echo $DOCKER_PASSWORD)
          docker push radoslawc/nmath-test:latest
        env:
          - name: DOCKER_USERNAME
            valueFrom:
              secretKeyRef:
                name: dockerhub-creds
                key: username
          - name: DOCKER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: dockerhub-creds
                key: password
        volumeMounts:
          - name: docker-socket
            mountPath: /var/run/docker.sock
      volumes:
        - name: docker-socket
          hostPath:
            path: /var/run/docker.sock
postsubmits:
  - name: verify-image-build
    cluster: default
    always_run: true
    skip_branches:
    annotations:
      description: Verify image build on pull requests to main branch
    decorate: true
    decoration_config:
      censor_secrets: true
    spec:
      containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor:v1.9.2
        command:
        - /kaniko/executor
        args:
        - --context=/home/prow/go/src/github.com/radochm/build-test
        - --dockerfile=Dockerfile
        - --no-push
        resources:
          requests:
            cpu: 6
            memory: 9Gi
